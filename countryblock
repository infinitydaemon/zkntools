#!/bin/bash

# Function to validate country codes (simple check for 2 uppercase letters)
validate_country_code() {
    if [[ $1 =~ ^[A-Z]{2}$ ]]; then
        return 0
    else
        return 1
    fi
}

# Ask the user which countries to block
echo "Enter the country codes you want to block (e.g., CN RU IR)."
echo "You can find country codes here: https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2"
read -p "Country codes: " -a COUNTRIES

# Validate the input
for COUNTRY in "${COUNTRIES[@]}"; do
    if ! validate_country_code "$COUNTRY"; then
        echo "Invalid country code: $COUNTRY. Please use 2-letter uppercase codes (e.g., CN, RU)."
        exit 1
    fi
done

# Create an ipset for storing the IP ranges
IPSET_NAME="blocked_countries"
sudo ipset create $IPSET_NAME hash:net

# Download the IP ranges for the specified countries
for COUNTRY in "${COUNTRIES[@]}"; do
    echo "Blocking $COUNTRY..."
    wget -O - http://www.ipdeny.com/ipblocks/data/countries/$COUNTRY.zone 2>/dev/null | while read IP; do
        sudo ipset add $IPSET_NAME $IP
    done
done

# Block the IPs using iptables
sudo iptables -I INPUT -m set --match-set $IPSET_NAME src -j DROP
sudo iptables -I FORWARD -m set --match-set $IPSET_NAME src -j DROP

echo "Traffic from the following countries has been blocked: ${COUNTRIES[*]}"
